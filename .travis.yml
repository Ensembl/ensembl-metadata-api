language: python
os: linux

python:
  - "3.8"
  - "3.9"

env:
  - TESTENV=test

services:
  - mysql

before_script:
  - pip install -r requirements-test.txt
  - pip install .
  - export PYTHONPATH=$PYTHONPATH:$PWD/src
  - mysql -u root -h 127.0.0.1 -e 'CREATE DATABASE ncbi_taxonomy; CREATE DATABASE ensembl_metadata_2020; use ncbi_taxonomy; source tests/ncbi_taxonomy.sql; use ensembl_metadata_2020; source tests/ensembl_metadata_2020.sql;'

script:
  - if [[ "$TESTENV" == "test" ]]; then coverage run -m pytest; fi

deploy:
- provider: pypi
  server: https://test.pypi.org/legacy/
  username: __token__
  password:
    secure: pypi-AgENdGVzdC5weXBpLm9yZwIkZmE4NzQyNDItOGYxZi00YmU4LWJhMjUtOGY4MTFlZDJkNTdhAAIqWzMsImUxMTA1NjRlLTUxYTktNDdkMi04MjVkLTFjMTA4MzNkYzY5MyJdAAAGID2E1vVgEWQEXR7Jx_9LTDDYwvzZS69seAqy3cSHDje3
  on:
    tags: true
    repo: Ensembl/ensembl-metadata-api
    condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?-test(\.[0-9]+)?$
- provider: pypi
  username: __token__
  password:
    secure: pypi-AgEIcHlwaS5vcmcCJDEzNGYzYWFmLWFjZjctNGNhZi1hZDYwLWI1ODliMTRlNTM3ZQACKlszLCI2ZWE2YjRkZC0wMjM2LTRjNWQtODI1Mi01NDVhY2UzZjc2NDgiXQAABiBVFYpoaz8RC85SBbrxa2yGgGBPj02vzW0GFKIQZ5apxQ
  on:
    tags: true
    repo: Ensembl/ensembl-metadata-api
    condition: $TRAVIS_TAG =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$